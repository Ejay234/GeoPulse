<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoPulse — Geothermal Sweet Spot Identifier</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0f1117;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: #1a1d27;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #d73027;
            flex-shrink: 0;
        }
        .logo h1 { font-size: 22px; color: #d73027; font-weight: 700; letter-spacing: 1px; }
        .logo span { font-size: 12px; color: #888; }
        .header-right { display: flex; align-items: center; gap: 16px; font-size: 12px; color: #888; }
        .status-badge {
            padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: bold;
        }
        .status-idle    { background: #2a2d3a; color: #888; }
        .status-running { background: #2a3a1a; color: #8bc34a; }
        .status-done    { background: #1a2a3a; color: #4fc3f7; }
        .status-error   { background: #3a1a1a; color: #ef5350; }

        /* Loading Screen */
        .loading-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 24px;
        }
        .loading-icon { font-size: 64px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
        .loading-title { font-size: 24px; color: #d73027; font-weight: 700; }
        .loading-step  { font-size: 14px; color: #888; }
        .progress-bar-outer {
            width: 360px; height: 8px;
            background: #2a2d3a; border-radius: 4px; overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%; background: #d73027;
            border-radius: 4px; transition: width 0.5s ease;
        }
        .loading-note { font-size: 12px; color: #555; text-align: center; max-width: 360px; }
        .error-box {
            background: #2a1010; border: 1px solid #d73027;
            border-radius: 8px; padding: 16px; max-width: 500px;
            font-size: 12px; color: #ef5350; font-family: monospace;
        }

        /* Main Dashboard */
        .main { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 300px; background: #1a1d27;
            border-right: 1px solid #2a2d3a;
            display: flex; flex-direction: column;
            overflow-y: auto; flex-shrink: 0;
        }
        .sidebar-section { padding: 16px; border-bottom: 1px solid #2a2d3a; }
        .sidebar-section h3 {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 1px; color: #888; margin-bottom: 12px;
        }
        .top-site-card {
            background: linear-gradient(135deg, #1a0a0a, #2a1010);
            border: 1px solid #d73027; border-radius: 8px; padding: 12px;
        }
        .top-site-card .score { font-size: 32px; font-weight: 700; color: #d73027; line-height: 1; }
        .top-site-card .score-label { font-size: 10px; color: #888; margin-bottom: 8px; }
        .top-site-card .name { font-size: 14px; font-weight: 600; color: #fff; }
        .top-site-card .coords { font-size: 11px; color: #888; margin-top: 4px; }
        .site-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 0; border-bottom: 1px solid #2a2d3a;
        }
        .site-item:last-child { border-bottom: none; }
        .rank-badge {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; flex-shrink: 0; color: #111;
        }
        .site-info { flex: 1; }
        .site-name  { font-size: 12px; font-weight: 600; color: #e0e0e0; }
        .site-coords { font-size: 10px; color: #666; }
        .site-gps { font-size: 13px; font-weight: 700; }
        .formula-box {
            background: #0f1117; border: 1px solid #2a2d3a;
            border-radius: 6px; padding: 10px 12px; font-size: 12px; line-height: 1.8;
        }
        .formula { color: #4fc3f7; font-family: monospace; font-size: 11px; }
        .weight-bar { display: flex; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .w-lst  { background: #d73027; flex: 5; }
        .w-grid { background: #fc8d59; flex: 3; }
        .w-svi  { background: #fee08b; flex: 2; }
        .run-btn {
            width: 100%; padding: 10px; background: #d73027;
            color: white; border: none; border-radius: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        .run-btn:hover { background: #b71c1c; }
        .run-btn:disabled { background: #444; cursor: not-allowed; }
        .run-status { font-size: 11px; color: #888; margin-top: 8px; min-height: 16px; }

        /* Map */
        .map-container { flex: 1; position: relative; }
        .map-container iframe { width: 100%; height: 100%; border: none; }

        /* Reset button */
        .reset-btn { background: none; border: 1px solid #2a2d3a; color: #888; padding: 6px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 100%; margin-bottom: 10px; transition: all 0.2s; }
        .reset-btn:hover { border-color: #d73027; color: #d73027; }

        /* Gemini Chat Panel */
        .chat-panel { width: 300px; background: #1a1d27; border-left: 1px solid #2a2d3a; display: flex; flex-direction: column; flex-shrink: 0; }
        .chat-header { padding: 12px 16px; border-bottom: 1px solid #2a2d3a; flex-shrink: 0; }
        .chat-header h3 { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; }
        .chat-header p { font-size: 10px; color: #555; margin-top: 3px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { font-size: 12px; line-height: 1.6; padding: 8px 10px; border-radius: 6px; }
        .chat-msg.user { background: #1e2a3a; color: #c0d0e8; align-self: flex-end; max-width: 90%; }
        .chat-msg.gemini { background: #0f1117; border: 1px solid #2a2d3a; color: #c8d0e0; align-self: flex-start; max-width: 95%; }
        .chat-msg.thinking { color: #555; font-style: italic; }
        .chat-input-row { padding: 10px 12px; border-top: 1px solid #2a2d3a; display: flex; gap: 8px; flex-shrink: 0; }
        .chat-input { flex: 1; background: #0f1117; border: 1px solid #2a2d3a; color: #e0e0e0; padding: 7px 10px; border-radius: 4px; font-size: 12px; font-family: 'Segoe UI', Arial, sans-serif; resize: none; }
        .chat-input:focus { outline: none; border-color: #d73027; }
        .chat-send { background: #d73027; color: white; border: none; border-radius: 4px; padding: 7px 12px; font-size: 12px; cursor: pointer; flex-shrink: 0; }
        .chat-send:hover { background: #b71c1c; }
        .chat-send:disabled { background: #444; cursor: not-allowed; }
        .chat-suggestions { padding: 0 12px 10px; display: flex; flex-direction: column; gap: 4px; }
        .suggestion { background: #0f1117; border: 1px solid #2a2d3a; color: #888; padding: 5px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; text-align: left; transition: all 0.15s; }
        .suggestion:hover { border-color: #d73027; color: #e0e0e0; }

        /* Color helpers */
        .c-red    { color: #d73027; } .bg-red    { background: #d73027; }
        .c-orange { color: #fc8d59; } .bg-orange { background: #fc8d59; }
        .c-yellow { color: #e6b800; } .bg-yellow { background: #fee08b; }
        .c-green  { color: #91cf60; } .bg-green  { background: #91cf60; }
    </style>
</head>
<body>

<!-- Header -->
<header>
    <div class="logo">
    <!-- Minimal Eco Logo (GeoPulse) — generated by ChatGPT (OpenAI) -->
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 220" role="img" aria-label="GeoPulse logo"
        style="height:50px; width:auto; display:block;">
        <defs>
        <linearGradient id="ecoGrad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#1B9E77"/>
            <stop offset="100%" stop-color="#66A61E"/>
        </linearGradient>
        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000000" flood-opacity="0.12"/>
        </filter>
        </defs>
        <g transform="translate(40,30)" filter="url(#shadow)">
        <circle cx="80" cy="80" r="64" fill="none" stroke="url(#ecoGrad)" stroke-width="14" stroke-linecap="round"/>
        <path d="M26 82 L52 82 L62 66 L74 104 L88 74 L98 82 L134 82"
                fill="none" stroke="#0B1B2A" stroke-opacity="0.85"
                stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M26 82 L62 82 L62 66 L74 104 L88 74 L134 82"
                fill="none" stroke="url(#ecoGrad)"
                stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <g transform="translate(200,68)">
        <text x="0" y="70"
                font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial"
                font-size="76" font-weight="750" letter-spacing="-1.2" fill="#1B9E77">
            Geo<tspan fill="url(#ecoGrad)">Pulse</tspan>
        </text>
        </g>
    </svg>
</div>
    <div class="header-right">
        {% if last_run %}<span>Last run: {{ last_run }}</span>{% endif %}
        <span class="status-badge status-{{ status }}" id="statusBadge">{{ status.upper() }}</span>
    </div>
</header>

<!-- Loading Screen (shown while pipeline is running) -->
{% if status == 'running' %}
<div class="loading-screen" id="loadingScreen">
    <div class="loading-title">Analyzing Satellite Data...</div>
    <div class="loading-step" id="loadingStep">{{ step }}</div>
    <div class="progress-bar-outer">
        <div class="progress-bar-inner" id="progressBar" style="width: {{ progress }}%"></div>
    </div>
    <div class="loading-note">
        GeoPulse is fetching Landsat imagery from Google Earth Engine,
        scoring geothermal potential, and generating your interactive map.
        This takes about 3&ndash;5 minutes.
    </div>
</div>

<!-- Error Screen -->
{% elif status == 'error' %}
<div class="loading-screen">
    <div class="loading-title" style="color:#ef5350;">Pipeline Error</div>
    <div class="loading-step">{{ step }}</div>
    {% if error %}
    <div class="error-box">{{ error }}</div>
    {% endif %}
    <button class="run-btn" style="width:200px;" onclick="triggerRun()">Retry</button>
</div>

<!-- Main Dashboard -->
{% else %}
<div class="main" id="dashboard">

    <div class="sidebar">

        <!-- Top Site -->
        {% if top_site %}
        <div class="sidebar-section">
            <h3>Top Candidate Site</h3>
            <div class="top-site-card">
                <div class="score">{{ top_site.gps }}</div>
                <div class="score-label">GPS SCORE / 100</div>
                <div class="name">{{ top_site.name }}</div>
                <div class="coords">{{ top_site.lat }}, {{ top_site.lon }}</div>
            </div>
        </div>
        {% endif %}

        <!-- Site List -->
        <div class="sidebar-section">
            <h3>Candidate Sites ({{ sites|length }})</h3>
            {% for site in sites %}
                {% set gps = site.gps %}
                {% if gps >= 85 %}{% set cc='c-red' %}{% set bc='bg-red' %}
                {% elif gps >= 70 %}{% set cc='c-orange' %}{% set bc='bg-orange' %}
                {% elif gps >= 60 %}{% set cc='c-yellow' %}{% set bc='bg-yellow' %}
                {% else %}{% set cc='c-green' %}{% set bc='bg-green' %}{% endif %}
            <div class="site-item">
                <div class="rank-badge {{ bc }}">{{ site.rank }}</div>
                <div class="site-info">
                    <div class="site-name">{{ site.name }}</div>
                    <div class="site-coords">{{ site.lat }}, {{ site.lon }}</div>
                </div>
                <div class="site-gps {{ cc }}">{{ site.gps }}</div>
            </div>
            {% else %}
            <p style="font-size:12px; color:#666;">No sites yet. Run the pipeline.</p>
            {% endfor %}
        </div>

        <!-- Formula -->
        <div class="sidebar-section">
            <h3>Scoring Formula</h3>
            <div class="formula-box">
                <div class="formula">GPS = 0.5×LST + 0.3×Grid + 0.2×SVI</div>
                <div class="weight-bar">
                    <div class="w-lst"></div>
                    <div class="w-grid"></div>
                    <div class="w-svi"></div>
                </div>
                <div style="display:flex; gap:8px; margin-top:6px; font-size:10px;">
                    <span class="c-red">■ LST 50%</span>
                    <span class="c-orange">■ Grid 30%</span>
                    <span class="c-yellow">■ SVI 20%</span>
                </div>
            </div>
        </div>

        <!-- Run Pipeline -->
        <div class="sidebar-section">
            <h3>Pipeline Control</h3>
            <button class="reset-btn" onclick="resetDefaults()">Reset to Defaults</button>
            <button class="run-btn" id="runBtn" onclick="triggerRun()">
                Run Fresh Analysis
            </button>
            <div class="run-status" id="runStatus"></div>
            <p style="font-size:10px; color:#555; margin-top:8px;">
                Re-fetches latest Landsat data from GEE, rescores all sites,
                and regenerates the map (~3&ndash;5 min).
            </p>
        </div>

    </div><!-- /sidebar -->

    <div class="map-container">
        <iframe src="/map" id="mapFrame"></iframe>
    </div>

    <!-- Gemini Chat Panel -->
    <div class="chat-panel">
        <div class="chat-header">
            <h3>AI Analyst — Gemini</h3>
            <p>Ask questions about the geothermal data</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="chat-msg gemini">
                Hello! I'm your GeoPulse analyst. I can explain the scoring methodology, interpret site results, or help you understand what the satellite data means for geothermal development. What would you like to know?
            </div>
        </div>

        <!-- Quick suggestion buttons -->
        <div class="chat-suggestions" id="chatSuggestions">
            <button class="suggestion" onclick="sendSuggestion(this)">Why is Beaver County ranked highest?</button>
            <button class="suggestion" onclick="sendSuggestion(this)">Explain the GPS scoring formula</button>
            <button class="suggestion" onclick="sendSuggestion(this)">What does the SVI equity layer mean?</button>
            <button class="suggestion" onclick="sendSuggestion(this)">How does LST indicate geothermal potential?</button>
        </div>

        <div class="chat-input-row">
            <textarea class="chat-input" id="chatInput" rows="2" placeholder="Ask about the data..."
                onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendChat();}"></textarea>
            <button class="chat-send" id="chatSend" onclick="sendChat()">Send</button>
        </div>
    </div>

</div><!-- /main -->
{% endif %}

<script>
    // Polls /api/status every 3 seconds, updates progress bar + step text,
    // and reloads the page when pipeline completes.
    {% if status == 'running' %}
    function pollStatus() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                // Update step text
                const stepEl = document.getElementById('loadingStep');
                if (stepEl) stepEl.textContent = data.step || '';

                // Update progress bar
                const bar = document.getElementById('progressBar');
                if (bar) bar.style.width = (data.progress || 0) + '%';

                // Update status badge
                const badge = document.getElementById('statusBadge');
                if (badge) {
                    badge.textContent = data.status.toUpperCase();
                    badge.className = 'status-badge status-' + data.status;
                }

                if (data.status === 'done' || data.status === 'error') {
                    // Pipeline finished — reload to show dashboard or error screen
                    location.reload();
                } else {
                    // Still running — poll again in 3 seconds
                    setTimeout(pollStatus, 3000);
                }
            })
            .catch(() => setTimeout(pollStatus, 5000)); // retry on network error
    }

    // Start polling immediately
    pollStatus();
    {% endif %}

    // Reset parameters to defaults
    function resetDefaults() {
        document.getElementById('start_date').value  = '2023-05-01';
        document.getElementById('end_date').value    = '2024-09-30';
        document.getElementById('cloud_cover').value = 20;
        document.getElementById('weight_lst').value  = 0.5;
        document.getElementById('weight_grid').value = 0.3;
        document.getElementById('weight_svi').value  = 0.2;
        document.getElementById('num_sites').value   = 10;
        document.getElementById('percentile').value  = 70;
        document.getElementById('cloud_val').textContent = '20%';
        document.getElementById('pct_val').textContent   = '70th';
        updateWeights();
    }

    // Gemini chat
    function sendSuggestion(btn) {
        document.getElementById('chatInput').value = btn.textContent;
        document.getElementById('chatSuggestions').style.display = 'none';
        sendChat();
    }

    function sendChat() {
        const input = document.getElementById('chatInput');
        const msg = input.value.trim();
        if (!msg) return;

        const messages = document.getElementById('chatMessages');
        const sendBtn  = document.getElementById('chatSend');

        // Add user message
        messages.innerHTML += '<div class="chat-msg user">' + msg + '</div>';
        messages.innerHTML += '<div class="chat-msg thinking" id="thinkingMsg">Analyzing data...</div>';
        messages.scrollTop = messages.scrollHeight;
        input.value = '';
        sendBtn.disabled = true;

        fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
        })
        .then(r => r.json())
        .then(data => {
            const thinking = document.getElementById('thinkingMsg');
            if (thinking) thinking.remove();
            messages.innerHTML += '<div class="chat-msg gemini">' + data.reply.replace(/\n/g, '<br>') + '</div>';
            messages.scrollTop = messages.scrollHeight;
            sendBtn.disabled = false;
        })
        .catch(() => {
            const thinking = document.getElementById('thinkingMsg');
            if (thinking) thinking.textContent = 'Error connecting to Gemini. Check your API key.';
            sendBtn.disabled = false;
        });
    }

    // Trigger fresh pipeline run
    function triggerRun() {
        const btn = document.getElementById('runBtn');
        const statusEl = document.getElementById('runStatus');

        if (btn) { btn.disabled = true; btn.textContent = 'Starting...'; }
        if (statusEl) statusEl.textContent = 'Sending request...';

        fetch('/run', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (statusEl) statusEl.textContent = 'Pipeline started — reloading...';
                // Reload after short delay so server has time to update state
                setTimeout(() => location.reload(), 1500);
            })
            .catch(() => {
                if (statusEl) statusEl.textContent = 'Error starting pipeline.';
                if (btn) { btn.disabled = false; btn.textContent = 'Run Fresh Analysis'; }
            });
    }
</script>

</body>
</html>